<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Staff Appointments</title>
    <link rel="stylesheet" href="/css/staff/staff.css">
    <script src="/js/staff/staff.js" defer></script>
</head>
<body>
<div class="app-wrapper">

    <div th:replace="staff/fragments/sidebar :: sidebar"></div>

    <div class="main-content">
        <div th:replace="staff/fragments/header :: header"></div>

        <div class="content">
            <h2> Quản lý lịch khám</h2>

            <form method="get" th:action="@{/staff/appointments}" class="filter-form">
                <input type="text"
                       name="keyword"
                       placeholder=" Tìm tên bệnh nhân..."
                       th:value="${keyword}"/>

                <select name="sort">
                    <option value="">-- Sắp xếp theo ngày --</option>
                    <option value="newest" th:selected="${sort == 'newest'}">
                         Mới nhất
                    </option>
                    <option value="oldest" th:selected="${sort == 'oldest'}">
                         Cũ nhất
                    </option>
                </select>

                <button type="submit">Lọc</button>
            </form>


            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Bệnh nhân</th>
                    <th>Ngày</th>
                    <th>Giờ</th>
                    <th>Dịch vụ</th>
                    <th>Bác sĩ</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="a : ${appointments}">
                    <td th:text="${a.id}"></td>
                    <td th:text="${a.customer.fullName}"></td>
                    <td th:text="${a.date}"></td>
                    <td th:text="${a.startTime}"></td>

                    <!-- Dịch vụ -->
                    <td th:text="${a.service != null ? a.service.name : 'N/A'}"></td>

                    <!-- Bác sĩ -->
                    <td th:text="${a.dentist != null ? a.dentist.fullName : 'Chưa gán'}"></td>

                    <td th:text="${a.status}"></td>

                    <td>
                        <!-- Xác nhận: chỉ khi PENDING và đã có dentist -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING' and a.dentist != null}"
                                th:onclick="'confirmAppointment(' + ${a.id} + ')'">
                            Xác nhận
                        </button>

                        <!-- Gán BS: khi PENDING -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING'}"
                                th:onclick="'assignDentist(' + ${a.id} + ')'">
                            Gán BS
                        </button>

                        <!-- Check in: khi CONFIRMED -->
                        <button type="button"
                                th:if="${a.status.name() == 'CONFIRMED'}"
                                th:onclick="'checkInAppointment(' + ${a.id} + ')'">
                            Check in
                        </button>

                        <!-- Hoàn thành: khi CHECKED_IN -->
                        <button type="button"
                                th:if="${a.status.name() == 'CHECKED_IN'}"
                                th:onclick="'completeAppointment(' + ${a.id} + ')'">
                            Hoàn thành
                        </button>

                        <!-- Hủy: khi PENDING -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING'}"
                                th:onclick="'cancelAppointment(' + ${a.id} + ')'">
                            Hủy
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 0}"
                   th:href="@{/staff/appointments(page=${currentPage - 1}, keyword=${keyword}, sort=${sort})}">
                    ◀ Trước
                </a>

                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:href="@{/staff/appointments(page=${i}, keyword=${keyword}, sort=${sort})}"
                        th:text="${i + 1}"
                        th:classappend="${i == currentPage} ? 'active'">
                    </a>
                </span>

                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/staff/appointments(page=${currentPage + 1}, keyword=${keyword}, sort=${sort})}">
                    Sau ▶
                </a>
            </div>

        </div>
    </div>
</div>
</body>
</html>
