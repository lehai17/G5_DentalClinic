<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Staff Appointments</title>
    <link rel="stylesheet" href="/css/staff/staff.css">
    <script src="/js/staff/staff.js" defer></script>
</head>
<body>
<div class="app-wrapper">

    <div th:replace="staff/fragments/sidebar :: sidebar"></div>

    <div class="main-content">
        <div th:replace="staff/fragments/header :: header"></div>

        <div class="content">
            <h2> Appointment Management</h2>

            <form method="get" th:action="@{/staff/appointments}" class="filter-form">
                <input type="text"
                       name="keyword"
                       placeholder=" Search by name..."
                       th:value="${keyword}"/>

                <input type="text"
                       name="serviceKeyword"
                       placeholder=" Search by service..."
                       th:value="${serviceKeyword}"/>

                <select name="sort">
                    <option value="">-- Sort by date --</option>
                    <option value="newest" th:selected="${sort == 'newest'}">
                         Newest
                    </option>
                    <option value="oldest" th:selected="${sort == 'oldest'}">
                         Oldest
                    </option>
                </select>

                <button type="submit">Filter</button>
            </form>


            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Service</th>
                    <th>Dentist</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="a : ${appointments}">
                    <td th:text="${a.id}"></td>
                    <td th:text="${a.customer.fullName}"></td>
                    <td th:text="${a.date}"></td>
                    <td th:text="${a.startTime}"></td>
                    <td th:text="${a.service != null ? a.service.name : 'Chưa chọn dịch vụ'}"></td>
                    <td th:text="${a.dentist != null ? a.dentist.fullName : 'Chưa gán'}"></td>
                    <td th:text="${a.service.name}"></td>
                    <td th:text="${a.dentist != null ? a.dentist.fullName : 'Not yet assigned'}"></td>
                    <td th:text="${a.status}"></td>

                    <td>
                        <!-- PENDING + CHƯA gán bác sĩ -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING' and a.dentist == null}"
                                th:onclick="'assignDentist(' + ${a.id} + ')'">
                            Gán BS
                        </button>

                        <!-- PENDING + ĐÃ gán bác sĩ => chỉ cho xác nhận -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING' and a.dentist != null}"
                                th:onclick="'confirmAppointment(' + ${a.id} + ')'">
                            Confirm
                        </button>

                        <!-- CONFIRMED => Check-in -->
                        <button type="button"
                                th:if="${a.status.name() == 'CONFIRMED'}"
                                th:onclick="'checkInAppointment(' + ${a.id} + ')'">
                            Check-in
                                th:if="${a.status.name() == 'PENDING'}"
                                th:onclick="'assignDentist(' + ${a.id} + ')'">
                            Assign dentist
                        </button>

                        <!-- CHECKED_IN => Hoàn thành -->
                        <button type="button"
                                th:if="${a.status.name() == 'CHECKED_IN'}"
                                th:onclick="'completeAppointment(' + ${a.id} + ')'">
                            Complete
                        </button>

                        <!-- Cho phép hủy khi chưa check-in -->
                        <button type="button"
                                th:if="${a.status.name() == 'PENDING' or a.status.name() == 'CONFIRMED'}"
                                th:onclick="'cancelAppointment(' + ${a.id} + ')'">
                            Cancel
                        </button>

                        <button th:if="${a.status.name() == 'COMPLETED'}"
                                th:onclick="'goToPayment(' + ${a.id} + ')'">
                            Payment
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination" th:if="${totalPages > 1}">
                <a th:if="${currentPage > 0}"
                   th:href="@{/staff/appointments(page=${currentPage - 1}, keyword=${keyword}, serviceKeyword=${serviceKeyword},sort=${sort})}">
                    ◀ Previous
                </a>

                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:href="@{/staff/appointments(page=${i}, keyword=${keyword},serviceKeyword=${serviceKeyword}, sort=${sort})}"
                        th:text="${i + 1}"
                        th:classappend="${i == currentPage} ? 'active'">
                    </a>
                </span>

                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/staff/appointments(page=${currentPage + 1}, keyword=${keyword},serviceKeyword=${serviceKeyword}, sort=${sort})}">
                    After ▶
                </a>
            </div>

        </div>
    </div>
</div>
</body>
</html>
