<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chi tiet phieu ho tro</title>

    <link rel="stylesheet" th:href="@{/css/dentist/app.css}"/>
    <link rel="stylesheet" th:href="@{/css/dentist/support.css}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"/>
</head>
<body>
<div class="app-shell">

    <aside class="sidebar" id="sidebar" style="display:flex;flex-direction:column;height:100vh;">
        <div class="sidebar-top">
            <div class="brand-mini">
                <div class="brand-badge">D+</div>
                <div style="font-weight:800">DentalPlus</div>
            </div>
        </div>

        <nav class="nav">
            <a class="nav-item" href="/dentist/dashboard">Tong quan</a>
            <a class="nav-item" href="/dentist/work-schedule">Lich lam viec</a>
            <a class="nav-item active" href="/dentist/support">Ho tro chuyen mon</a>
            <a class="nav-item" href="/dentist/profile">Ho so</a>
        </nav>

        <div style="margin-top:auto;">
            <a class="nav-item danger" href="/logout">Dang xuat</a>
        </div>
    </aside>

    <div class="main">
        <div class="topbar">
            <a class="support-back-link" href="/dentist/support"><i class="bi bi-arrow-left"></i> Quay lai danh sach</a>
        </div>

        <div class="content">
            <section class="detail-card">
                <header class="detail-header">
                    <div>
                        <h1 class="detail-name" th:text="${ticket.title != null && !#strings.isEmpty(ticket.title) ? ticket.title : 'Phieu ho tro'}"></h1>
                        <div class="detail-meta">
                            Ma phieu: <strong>#<span th:text="${ticket.id}"></span></strong>
                            <span class="dot">â€¢</span>
                            <span th:text="${#temporals.format(ticket.createdAt,'dd/MM/yyyy HH:mm')}"></span>
                        </div>
                    </div>

                    <div>
                        <span class="badge open" th:if="${ticket.status.name() == 'OPEN'}">Dang mo</span>
                        <span class="badge answered" th:if="${ticket.status.name() == 'ANSWERED'}">Da tra loi</span>
                        <span class="badge closed" th:if="${ticket.status.name() == 'CLOSED'}">Da dong</span>
                    </div>
                </header>

                <div th:if="${successMessage}" class="support-flash flash-success" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="support-flash flash-error" th:text="${errorMessage}"></div>

                <section class="detail-section detail-grid">
                    <div class="detail-info-box">
                        <div class="detail-section-title"><i class="bi bi-person-circle"></i> Khach hang</div>
                        <p th:text="${ticket.customer != null ? (ticket.customer.customerProfile != null ? ticket.customer.customerProfile.fullName : ticket.customer.email) : '-'}"></p>
                        <p class="muted" th:text="${ticket.customer != null ? ticket.customer.email : ''}"></p>
                    </div>

                    <div class="detail-info-box">
                        <div class="detail-section-title"><i class="bi bi-calendar2-check"></i> Loai ho tro</div>
                        <p th:if="${ticket.appointment != null}">
                            Lien quan ca kham #<strong th:text="${ticket.appointment.id}"></strong>
                        </p>
                        <p th:if="${ticket.appointment == null}">Ho tro chung (khong gan ca kham)</p>
                    </div>
                </section>

                <section class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-chat-left-text"></i> Noi dung khach hang hoi</div>
                    <div class="detail-box" th:text="${ticket.question}"></div>
                </section>

                <section class="detail-section">
                    <div class="detail-section-title"><i class="bi bi-reply"></i> Phan hoi cua bac si</div>

                    <div class="detail-box answer-box" th:if="${ticket.answer != null && !#strings.isEmpty(ticket.answer)}" th:text="${ticket.answer}"></div>

                    <form th:if="${ticket.status.name() == 'OPEN' && (ticket.answer == null || #strings.isEmpty(ticket.answer))}"
                          th:action="@{'/dentist/support/' + ${ticket.id} + '/answer'}"
                          method="post"
                          class="answer-form">
                        <textarea name="answer" rows="5" required class="answer-input" placeholder="Nhap phan hoi cho khach hang..."></textarea>
                        <div class="answer-actions">
                            <button class="btn primary" type="submit"><i class="bi bi-send"></i> Gui phan hoi</button>
                        </div>
                    </form>

                    <div class="detail-note" th:if="${ticket.status.name() != 'OPEN'}">
                        Phieu da xu ly xong, ban khong the chinh sua noi dung phan hoi.
                    </div>
                </section>
            </section>
        </div>
    </div>
</div>
</body>
</html>
