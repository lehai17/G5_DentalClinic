<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Service & Billing Transfer</title>
  <link rel="stylesheet" href="/css/dentist/app.css"/>
  <link rel="stylesheet" href="/css/dentist/billing.css"/>
</head>
<body class="billing-page">
<div class="billing-container">
  <div class="billing-header">
    <div class="billing-title">Service & Billing Transfer</div>

    <div class="billing-meta">
      <div>
        <div class="meta-label">Appointment</div>
        <div class="meta-value" th:text="${appointmentId}">68</div>
      </div>

      <div>
        <div class="meta-label">Patient</div>
        <div class="meta-value" th:text="${patientName}">Nguyá»…n VÄƒn A</div>
      </div>

      <div>
        <div class="meta-label">Date</div>
        <div class="meta-value" th:text="${apptDate}">2026-02-26</div>
      </div>

      <div>
        <div class="meta-label">Time</div>
        <div class="meta-value">
          <span th:text="${#temporals.format(startTime,'HH:mm')}"></span>
          -
          <span th:text="${#temporals.format(endTime,'HH:mm')}"></span>
        </div>
      </div>
    </div>
  </div>

  <form id="billingForm" method="post" th:action="@{/dentist/appointments/{id}/billing-transfer(id=${appointmentId})}">
    <input type="hidden" name="customerUserId" th:value="${customerUserId}"/>
    <input type="hidden" name="dentistUserId" th:value="${dentistUserId}"/>
    <input type="hidden" id="appointmentStatus"
           th:value="${appointmentStatus}">

    <!-- hidden payloads -->
    <input type="hidden" id="performedServicesJson" name="performedServicesJson" th:value="${performedServicesJson}">
    <input type="hidden" id="prescriptionNote" name="prescriptionNote" th:value="${prescriptionNote}">
    <input type="hidden" name="weekStart" th:value="${weekStart}">

    <div class="billing-section">
      <div style="display:flex;justify-content:space-between;align-items:end;">
        <div>
          <div class="billing-section-title">
            A) Performed Services
          </div>
          <div class="mini">Tick the services actually performed (qty, tooth optional).</div>
        </div>
      </div>

      <div id="servicesBox">
        <div class="service-item"
             th:each="s : ${services}"
             th:attr="data-service-id=${s.id}">

          <div class="service-left">
            <input type="checkbox" class="svc-check">
            <span th:text="${s.name}">Scaling</span>
          </div>

          <div class="service-right">
            <input class="svc-qty" type="number" min="1" value="1">
            <input class="svc-tooth" type="text" placeholder="Tooth (e.g. 36)">
          </div>

        </div>
      </div>
    </div>

    <div class="billing-section">
      <div style="font-weight:900;">B) Digital Prescription</div>
      <div class="mini">Enter medications, dosage, duration, instruction (saved as JSON for staff).</div>

      <table class="tbl" id="rxTable">
        <thead>
        <tr>
          <th>Medication</th><th>Dosage</th><th>Duration</th><th>Instruction</th><th></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button type="button" class="icon-mini" id="btnAddRx">+ Add medicine</button>
    </div>

    <div class="billing-section">
      <div style="font-weight:900;">C) Note to Staff (optional)</div>
      <textarea name="note" rows="4" th:text="${note}" placeholder="Any note for billing/dispensing..."></textarea>
    </div>

    <div style="display:flex;gap:10px;margin-top:14px;">
      <button class="btn-primary" type="submit">SAVE</button>
      <a class="btn-secondary"
         th:href="@{/dentist/work-schedule(weekStart=${weekStart},dentistUserId=${dentistUserId})}">
        Back
      </a>

    </div>
  </form>
</div>

<script>
  // -------- helpers --------
  function safeJsonParse(s){
    try { return JSON.parse(s); } catch(e){ return null; }
  }

  // -------- prefill performed services --------
  (function prefillServices(){
    const raw = document.getElementById('performedServicesJson')?.value || '';
    const arr = safeJsonParse(raw);
    if(!Array.isArray(arr)) return;

    const rows = document.querySelectorAll('#servicesBox .service-item');
    rows.forEach(r => {
      const serviceId = Number(r.dataset.serviceId);
      const hit = arr.find(x => Number(x.serviceId) === serviceId);
      if(hit){
        r.querySelector('.svc-check').checked = true;
        r.querySelector('.svc-qty').value = hit.qty ?? 1;
        r.querySelector('.svc-tooth').value = hit.toothNo ?? '';
      }
    });
  })();

  // -------- RX dynamic table --------
  const rxTbody = document.querySelector('#rxTable tbody');
  function addRxRow(item){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="rx-name" placeholder="Name"></td>
      <td><input class="rx-dosage" placeholder="e.g. 500mg"></td>
      <td><input class="rx-duration" placeholder="e.g. 5 days"></td>
      <td><input class="rx-inst" placeholder="e.g. after meals"></td>
      <td><button type="button" class="icon-mini rx-del">âœ•</button></td>
    `;
    tr.querySelector('.rx-del').addEventListener('click', ()=> tr.remove());
    if(item){
      tr.querySelector('.rx-name').value = item.name || '';
      tr.querySelector('.rx-dosage').value = item.dosage || '';
      tr.querySelector('.rx-duration').value = item.duration || '';
      tr.querySelector('.rx-inst').value = item.instruction || '';
    }
    rxTbody.appendChild(tr);
  }

  document.getElementById('btnAddRx').addEventListener('click', ()=> addRxRow());

  // prefill prescription JSON
  (function prefillRx(){
    const raw = document.getElementById('prescriptionNote')?.value || '';
    const arr = safeJsonParse(raw);
    if(Array.isArray(arr) && arr.length){
      arr.forEach(addRxRow);
    } else {
      addRxRow(); // add 1 row by default
    }
  })();

  // -------- build payload on submit --------
  document.getElementById('billingForm').addEventListener('submit', (e) => {
    // performed services
    const out = [];
    document.querySelectorAll('#servicesBox .service-item').forEach(r => {
      const checked = r.querySelector('.svc-check').checked;
      if(!checked) return;
      out.push({
        serviceId: Number(r.dataset.serviceId),
        qty: Number(r.querySelector('.svc-qty').value || 1),
        toothNo: (r.querySelector('.svc-tooth').value || '').trim()
      });
    });
    document.getElementById('performedServicesJson').value = JSON.stringify(out);

    // rx
    const rx = [];
    document.querySelectorAll('#rxTable tbody tr').forEach(tr => {
      const name = tr.querySelector('.rx-name').value.trim();
      const dosage = tr.querySelector('.rx-dosage').value.trim();
      const duration = tr.querySelector('.rx-duration').value.trim();
      const instruction = tr.querySelector('.rx-inst').value.trim();
      if(name || dosage || duration || instruction){
        rx.push({ name, dosage, duration, instruction });
      }
    });
    document.getElementById('prescriptionNote').value = JSON.stringify(rx);
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {

    const status = document.getElementById('appointmentStatus')?.value;
    const locked = (status === 'DONE' || status === 'COMPLETED');

    if (status === 'DONE' || status === 'COMPLETED') {

      // ðŸ”’ Disable form fields
      document.querySelectorAll('input, textarea, select, button')
              .forEach(el => {
                el.disabled = true;
              });

      // ðŸ”¥ Remove submit button completely
      const saveBtn = document.querySelector('button[type="submit"]');
      if (saveBtn) saveBtn.remove();

      // ðŸ”¥ Remove all add buttons
      document.querySelectorAll('#btnAddRx')
              .forEach(btn => btn.remove());

    }
    document.querySelectorAll('.service-item').forEach(row => {
      const check = row.querySelector('.svc-check');
      const qty = row.querySelector('.svc-qty');
      const tooth = row.querySelector('.svc-tooth');

      function toggle() {
        const enabled = check.checked;
        qty.disabled = !enabled;
        tooth.disabled = !enabled;
      }

      check.addEventListener('change', toggle);
      toggle();
  });
  });
</script>

</body>
</html>
